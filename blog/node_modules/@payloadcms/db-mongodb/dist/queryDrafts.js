"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "queryDrafts", {
    enumerable: true,
    get: function() {
        return queryDrafts;
    }
});
const _database = require("payload/database");
const _buildSortParam = require("./queries/buildSortParam");
const _sanitizeInternalFields = /*#__PURE__*/ _interop_require_default(require("./utilities/sanitizeInternalFields"));
const _withSession = require("./withSession");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const queryDrafts = async function queryDrafts({ collection, limit, locale, page, pagination, req = {}, sort: sortArg, where }) {
    const VersionModel = this.versions[collection];
    const collectionConfig = this.payload.collections[collection].config;
    const options = (0, _withSession.withSession)(this, req.transactionID);
    let hasNearConstraint;
    let sort;
    if (where) {
        const constraints = (0, _database.flattenWhereToOperators)(where);
        hasNearConstraint = constraints.some((prop)=>Object.keys(prop).some((key)=>key === 'near'));
    }
    if (!hasNearConstraint) {
        sort = (0, _buildSortParam.buildSortParam)({
            config: this.payload.config,
            fields: collectionConfig.fields,
            locale,
            sort: sortArg || collectionConfig.defaultSort,
            timestamps: true
        });
    }
    const combinedWhere = (0, _database.combineQueries)({
        latest: {
            equals: true
        }
    }, where);
    const versionQuery = await VersionModel.buildQuery({
        locale,
        payload: this.payload,
        where: combinedWhere
    });
    // useEstimatedCount is faster, but not accurate, as it ignores any filters. It is thus set to true if there are no filters.
    const useEstimatedCount = hasNearConstraint || !versionQuery || Object.keys(versionQuery).length === 0;
    const paginationOptions = {
        forceCountFn: hasNearConstraint,
        lean: true,
        leanWithId: true,
        options,
        page,
        pagination,
        sort,
        useEstimatedCount
    };
    if (!useEstimatedCount && Object.keys(versionQuery).length === 0 && this.disableIndexHints !== true) {
        // Improve the performance of the countDocuments query which is used if useEstimatedCount is set to false by adding
        // a hint. By default, if no hint is provided, MongoDB does not use an indexed field to count the returned documents,
        // which makes queries very slow. This only happens when no query (filter) is provided. If one is provided, it uses
        // the correct indexed field
        paginationOptions.useCustomCountFn = ()=>{
            return Promise.resolve(VersionModel.countDocuments(versionQuery, {
                hint: {
                    _id: 1
                }
            }));
        };
    }
    if (limit > 0) {
        paginationOptions.limit = limit;
        // limit must also be set here, it's ignored when pagination is false
        paginationOptions.options.limit = limit;
    }
    const result = await VersionModel.paginate(versionQuery, paginationOptions);
    const docs = JSON.parse(JSON.stringify(result.docs));
    return {
        ...result,
        docs: docs.map((doc)=>{
            // eslint-disable-next-line no-param-reassign
            doc = {
                _id: doc.parent,
                id: doc.parent,
                ...doc.version,
                createdAt: doc.createdAt,
                updatedAt: doc.updatedAt
            };
            return (0, _sanitizeInternalFields.default)(doc);
        })
    };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9xdWVyeURyYWZ0cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFBhZ2luYXRlT3B0aW9ucyB9IGZyb20gJ21vbmdvb3NlJ1xuaW1wb3J0IHR5cGUgeyBRdWVyeURyYWZ0cyB9IGZyb20gJ3BheWxvYWQvZGF0YWJhc2UnXG5pbXBvcnQgdHlwZSB7IFBheWxvYWRSZXF1ZXN0IH0gZnJvbSAncGF5bG9hZC90eXBlcydcblxuaW1wb3J0IHsgY29tYmluZVF1ZXJpZXMsIGZsYXR0ZW5XaGVyZVRvT3BlcmF0b3JzIH0gZnJvbSAncGF5bG9hZC9kYXRhYmFzZSdcblxuaW1wb3J0IHR5cGUgeyBNb25nb29zZUFkYXB0ZXIgfSBmcm9tICcuJ1xuXG5pbXBvcnQgeyBidWlsZFNvcnRQYXJhbSB9IGZyb20gJy4vcXVlcmllcy9idWlsZFNvcnRQYXJhbSdcbmltcG9ydCBzYW5pdGl6ZUludGVybmFsRmllbGRzIGZyb20gJy4vdXRpbGl0aWVzL3Nhbml0aXplSW50ZXJuYWxGaWVsZHMnXG5pbXBvcnQgeyB3aXRoU2Vzc2lvbiB9IGZyb20gJy4vd2l0aFNlc3Npb24nXG5cbmV4cG9ydCBjb25zdCBxdWVyeURyYWZ0czogUXVlcnlEcmFmdHMgPSBhc3luYyBmdW5jdGlvbiBxdWVyeURyYWZ0cyhcbiAgdGhpczogTW9uZ29vc2VBZGFwdGVyLFxuICB7IGNvbGxlY3Rpb24sIGxpbWl0LCBsb2NhbGUsIHBhZ2UsIHBhZ2luYXRpb24sIHJlcSA9IHt9IGFzIFBheWxvYWRSZXF1ZXN0LCBzb3J0OiBzb3J0QXJnLCB3aGVyZSB9LFxuKSB7XG4gIGNvbnN0IFZlcnNpb25Nb2RlbCA9IHRoaXMudmVyc2lvbnNbY29sbGVjdGlvbl1cbiAgY29uc3QgY29sbGVjdGlvbkNvbmZpZyA9IHRoaXMucGF5bG9hZC5jb2xsZWN0aW9uc1tjb2xsZWN0aW9uXS5jb25maWdcbiAgY29uc3Qgb3B0aW9ucyA9IHdpdGhTZXNzaW9uKHRoaXMsIHJlcS50cmFuc2FjdGlvbklEKVxuXG4gIGxldCBoYXNOZWFyQ29uc3RyYWludFxuICBsZXQgc29ydFxuXG4gIGlmICh3aGVyZSkge1xuICAgIGNvbnN0IGNvbnN0cmFpbnRzID0gZmxhdHRlbldoZXJlVG9PcGVyYXRvcnMod2hlcmUpXG4gICAgaGFzTmVhckNvbnN0cmFpbnQgPSBjb25zdHJhaW50cy5zb21lKChwcm9wKSA9PiBPYmplY3Qua2V5cyhwcm9wKS5zb21lKChrZXkpID0+IGtleSA9PT0gJ25lYXInKSlcbiAgfVxuXG4gIGlmICghaGFzTmVhckNvbnN0cmFpbnQpIHtcbiAgICBzb3J0ID0gYnVpbGRTb3J0UGFyYW0oe1xuICAgICAgY29uZmlnOiB0aGlzLnBheWxvYWQuY29uZmlnLFxuICAgICAgZmllbGRzOiBjb2xsZWN0aW9uQ29uZmlnLmZpZWxkcyxcbiAgICAgIGxvY2FsZSxcbiAgICAgIHNvcnQ6IHNvcnRBcmcgfHwgY29sbGVjdGlvbkNvbmZpZy5kZWZhdWx0U29ydCxcbiAgICAgIHRpbWVzdGFtcHM6IHRydWUsXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IGNvbWJpbmVkV2hlcmUgPSBjb21iaW5lUXVlcmllcyh7IGxhdGVzdDogeyBlcXVhbHM6IHRydWUgfSB9LCB3aGVyZSlcblxuICBjb25zdCB2ZXJzaW9uUXVlcnkgPSBhd2FpdCBWZXJzaW9uTW9kZWwuYnVpbGRRdWVyeSh7XG4gICAgbG9jYWxlLFxuICAgIHBheWxvYWQ6IHRoaXMucGF5bG9hZCxcbiAgICB3aGVyZTogY29tYmluZWRXaGVyZSxcbiAgfSlcblxuICAvLyB1c2VFc3RpbWF0ZWRDb3VudCBpcyBmYXN0ZXIsIGJ1dCBub3QgYWNjdXJhdGUsIGFzIGl0IGlnbm9yZXMgYW55IGZpbHRlcnMuIEl0IGlzIHRodXMgc2V0IHRvIHRydWUgaWYgdGhlcmUgYXJlIG5vIGZpbHRlcnMuXG4gIGNvbnN0IHVzZUVzdGltYXRlZENvdW50ID1cbiAgICBoYXNOZWFyQ29uc3RyYWludCB8fCAhdmVyc2lvblF1ZXJ5IHx8IE9iamVjdC5rZXlzKHZlcnNpb25RdWVyeSkubGVuZ3RoID09PSAwXG4gIGNvbnN0IHBhZ2luYXRpb25PcHRpb25zOiBQYWdpbmF0ZU9wdGlvbnMgPSB7XG4gICAgZm9yY2VDb3VudEZuOiBoYXNOZWFyQ29uc3RyYWludCxcbiAgICBsZWFuOiB0cnVlLFxuICAgIGxlYW5XaXRoSWQ6IHRydWUsXG4gICAgb3B0aW9ucyxcbiAgICBwYWdlLFxuICAgIHBhZ2luYXRpb24sXG4gICAgc29ydCxcbiAgICB1c2VFc3RpbWF0ZWRDb3VudCxcbiAgfVxuXG4gIGlmIChcbiAgICAhdXNlRXN0aW1hdGVkQ291bnQgJiZcbiAgICBPYmplY3Qua2V5cyh2ZXJzaW9uUXVlcnkpLmxlbmd0aCA9PT0gMCAmJlxuICAgIHRoaXMuZGlzYWJsZUluZGV4SGludHMgIT09IHRydWVcbiAgKSB7XG4gICAgLy8gSW1wcm92ZSB0aGUgcGVyZm9ybWFuY2Ugb2YgdGhlIGNvdW50RG9jdW1lbnRzIHF1ZXJ5IHdoaWNoIGlzIHVzZWQgaWYgdXNlRXN0aW1hdGVkQ291bnQgaXMgc2V0IHRvIGZhbHNlIGJ5IGFkZGluZ1xuICAgIC8vIGEgaGludC4gQnkgZGVmYXVsdCwgaWYgbm8gaGludCBpcyBwcm92aWRlZCwgTW9uZ29EQiBkb2VzIG5vdCB1c2UgYW4gaW5kZXhlZCBmaWVsZCB0byBjb3VudCB0aGUgcmV0dXJuZWQgZG9jdW1lbnRzLFxuICAgIC8vIHdoaWNoIG1ha2VzIHF1ZXJpZXMgdmVyeSBzbG93LiBUaGlzIG9ubHkgaGFwcGVucyB3aGVuIG5vIHF1ZXJ5IChmaWx0ZXIpIGlzIHByb3ZpZGVkLiBJZiBvbmUgaXMgcHJvdmlkZWQsIGl0IHVzZXNcbiAgICAvLyB0aGUgY29ycmVjdCBpbmRleGVkIGZpZWxkXG4gICAgcGFnaW5hdGlvbk9wdGlvbnMudXNlQ3VzdG9tQ291bnRGbiA9ICgpID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgICAgIFZlcnNpb25Nb2RlbC5jb3VudERvY3VtZW50cyh2ZXJzaW9uUXVlcnksIHtcbiAgICAgICAgICBoaW50OiB7IF9pZDogMSB9LFxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBpZiAobGltaXQgPiAwKSB7XG4gICAgcGFnaW5hdGlvbk9wdGlvbnMubGltaXQgPSBsaW1pdFxuICAgIC8vIGxpbWl0IG11c3QgYWxzbyBiZSBzZXQgaGVyZSwgaXQncyBpZ25vcmVkIHdoZW4gcGFnaW5hdGlvbiBpcyBmYWxzZVxuICAgIHBhZ2luYXRpb25PcHRpb25zLm9wdGlvbnMubGltaXQgPSBsaW1pdFxuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgVmVyc2lvbk1vZGVsLnBhZ2luYXRlKHZlcnNpb25RdWVyeSwgcGFnaW5hdGlvbk9wdGlvbnMpXG4gIGNvbnN0IGRvY3MgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdC5kb2NzKSlcblxuICByZXR1cm4ge1xuICAgIC4uLnJlc3VsdCxcbiAgICBkb2NzOiBkb2NzLm1hcCgoZG9jKSA9PiB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cbiAgICAgIGRvYyA9IHtcbiAgICAgICAgX2lkOiBkb2MucGFyZW50LFxuICAgICAgICBpZDogZG9jLnBhcmVudCxcbiAgICAgICAgLi4uZG9jLnZlcnNpb24sXG4gICAgICAgIGNyZWF0ZWRBdDogZG9jLmNyZWF0ZWRBdCxcbiAgICAgICAgdXBkYXRlZEF0OiBkb2MudXBkYXRlZEF0LFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gc2FuaXRpemVJbnRlcm5hbEZpZWxkcyhkb2MpXG4gICAgfSksXG4gIH1cbn1cbiJdLCJuYW1lcyI6WyJxdWVyeURyYWZ0cyIsImNvbGxlY3Rpb24iLCJsaW1pdCIsImxvY2FsZSIsInBhZ2UiLCJwYWdpbmF0aW9uIiwicmVxIiwic29ydCIsInNvcnRBcmciLCJ3aGVyZSIsIlZlcnNpb25Nb2RlbCIsInZlcnNpb25zIiwiY29sbGVjdGlvbkNvbmZpZyIsInBheWxvYWQiLCJjb2xsZWN0aW9ucyIsImNvbmZpZyIsIm9wdGlvbnMiLCJ3aXRoU2Vzc2lvbiIsInRyYW5zYWN0aW9uSUQiLCJoYXNOZWFyQ29uc3RyYWludCIsImNvbnN0cmFpbnRzIiwiZmxhdHRlbldoZXJlVG9PcGVyYXRvcnMiLCJzb21lIiwicHJvcCIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJidWlsZFNvcnRQYXJhbSIsImZpZWxkcyIsImRlZmF1bHRTb3J0IiwidGltZXN0YW1wcyIsImNvbWJpbmVkV2hlcmUiLCJjb21iaW5lUXVlcmllcyIsImxhdGVzdCIsImVxdWFscyIsInZlcnNpb25RdWVyeSIsImJ1aWxkUXVlcnkiLCJ1c2VFc3RpbWF0ZWRDb3VudCIsImxlbmd0aCIsInBhZ2luYXRpb25PcHRpb25zIiwiZm9yY2VDb3VudEZuIiwibGVhbiIsImxlYW5XaXRoSWQiLCJkaXNhYmxlSW5kZXhIaW50cyIsInVzZUN1c3RvbUNvdW50Rm4iLCJQcm9taXNlIiwicmVzb2x2ZSIsImNvdW50RG9jdW1lbnRzIiwiaGludCIsIl9pZCIsInJlc3VsdCIsInBhZ2luYXRlIiwiZG9jcyIsIkpTT04iLCJwYXJzZSIsInN0cmluZ2lmeSIsIm1hcCIsImRvYyIsInBhcmVudCIsImlkIiwidmVyc2lvbiIsImNyZWF0ZWRBdCIsInVwZGF0ZWRBdCIsInNhbml0aXplSW50ZXJuYWxGaWVsZHMiXSwibWFwcGluZ3MiOiI7Ozs7K0JBWWFBOzs7ZUFBQUE7OzswQkFSMkM7Z0NBSXpCOytFQUNJOzZCQUNQOzs7Ozs7QUFFckIsTUFBTUEsY0FBMkIsZUFBZUEsWUFFckQsRUFBRUMsVUFBVSxFQUFFQyxLQUFLLEVBQUVDLE1BQU0sRUFBRUMsSUFBSSxFQUFFQyxVQUFVLEVBQUVDLE1BQU0sQ0FBQyxDQUFtQixFQUFFQyxNQUFNQyxPQUFPLEVBQUVDLEtBQUssRUFBRTtJQUVqRyxNQUFNQyxlQUFlLElBQUksQ0FBQ0MsUUFBUSxDQUFDVixXQUFXO0lBQzlDLE1BQU1XLG1CQUFtQixJQUFJLENBQUNDLE9BQU8sQ0FBQ0MsV0FBVyxDQUFDYixXQUFXLENBQUNjLE1BQU07SUFDcEUsTUFBTUMsVUFBVUMsSUFBQUEsd0JBQVcsRUFBQyxJQUFJLEVBQUVYLElBQUlZLGFBQWE7SUFFbkQsSUFBSUM7SUFDSixJQUFJWjtJQUVKLElBQUlFLE9BQU87UUFDVCxNQUFNVyxjQUFjQyxJQUFBQSxpQ0FBdUIsRUFBQ1o7UUFDNUNVLG9CQUFvQkMsWUFBWUUsSUFBSSxDQUFDLENBQUNDLE9BQVNDLE9BQU9DLElBQUksQ0FBQ0YsTUFBTUQsSUFBSSxDQUFDLENBQUNJLE1BQVFBLFFBQVE7SUFDekY7SUFFQSxJQUFJLENBQUNQLG1CQUFtQjtRQUN0QlosT0FBT29CLElBQUFBLDhCQUFjLEVBQUM7WUFDcEJaLFFBQVEsSUFBSSxDQUFDRixPQUFPLENBQUNFLE1BQU07WUFDM0JhLFFBQVFoQixpQkFBaUJnQixNQUFNO1lBQy9CekI7WUFDQUksTUFBTUMsV0FBV0ksaUJBQWlCaUIsV0FBVztZQUM3Q0MsWUFBWTtRQUNkO0lBQ0Y7SUFFQSxNQUFNQyxnQkFBZ0JDLElBQUFBLHdCQUFjLEVBQUM7UUFBRUMsUUFBUTtZQUFFQyxRQUFRO1FBQUs7SUFBRSxHQUFHekI7SUFFbkUsTUFBTTBCLGVBQWUsTUFBTXpCLGFBQWEwQixVQUFVLENBQUM7UUFDakRqQztRQUNBVSxTQUFTLElBQUksQ0FBQ0EsT0FBTztRQUNyQkosT0FBT3NCO0lBQ1Q7SUFFQSw0SEFBNEg7SUFDNUgsTUFBTU0sb0JBQ0psQixxQkFBcUIsQ0FBQ2dCLGdCQUFnQlgsT0FBT0MsSUFBSSxDQUFDVSxjQUFjRyxNQUFNLEtBQUs7SUFDN0UsTUFBTUMsb0JBQXFDO1FBQ3pDQyxjQUFjckI7UUFDZHNCLE1BQU07UUFDTkMsWUFBWTtRQUNaMUI7UUFDQVo7UUFDQUM7UUFDQUU7UUFDQThCO0lBQ0Y7SUFFQSxJQUNFLENBQUNBLHFCQUNEYixPQUFPQyxJQUFJLENBQUNVLGNBQWNHLE1BQU0sS0FBSyxLQUNyQyxJQUFJLENBQUNLLGlCQUFpQixLQUFLLE1BQzNCO1FBQ0EsbUhBQW1IO1FBQ25ILHFIQUFxSDtRQUNySCxtSEFBbUg7UUFDbkgsNEJBQTRCO1FBQzVCSixrQkFBa0JLLGdCQUFnQixHQUFHO1lBQ25DLE9BQU9DLFFBQVFDLE9BQU8sQ0FDcEJwQyxhQUFhcUMsY0FBYyxDQUFDWixjQUFjO2dCQUN4Q2EsTUFBTTtvQkFBRUMsS0FBSztnQkFBRTtZQUNqQjtRQUVKO0lBQ0Y7SUFFQSxJQUFJL0MsUUFBUSxHQUFHO1FBQ2JxQyxrQkFBa0JyQyxLQUFLLEdBQUdBO1FBQzFCLHFFQUFxRTtRQUNyRXFDLGtCQUFrQnZCLE9BQU8sQ0FBQ2QsS0FBSyxHQUFHQTtJQUNwQztJQUVBLE1BQU1nRCxTQUFTLE1BQU14QyxhQUFheUMsUUFBUSxDQUFDaEIsY0FBY0k7SUFDekQsTUFBTWEsT0FBT0MsS0FBS0MsS0FBSyxDQUFDRCxLQUFLRSxTQUFTLENBQUNMLE9BQU9FLElBQUk7SUFFbEQsT0FBTztRQUNMLEdBQUdGLE1BQU07UUFDVEUsTUFBTUEsS0FBS0ksR0FBRyxDQUFDLENBQUNDO1lBQ2QsNkNBQTZDO1lBQzdDQSxNQUFNO2dCQUNKUixLQUFLUSxJQUFJQyxNQUFNO2dCQUNmQyxJQUFJRixJQUFJQyxNQUFNO2dCQUNkLEdBQUdELElBQUlHLE9BQU87Z0JBQ2RDLFdBQVdKLElBQUlJLFNBQVM7Z0JBQ3hCQyxXQUFXTCxJQUFJSyxTQUFTO1lBQzFCO1lBRUEsT0FBT0MsSUFBQUEsK0JBQXNCLEVBQUNOO1FBQ2hDO0lBQ0Y7QUFDRiJ9