/* eslint-disable @typescript-eslint/no-var-requires */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "connect", {
    enumerable: true,
    get: function() {
        return connect;
    }
});
const _mongoose = /*#__PURE__*/ _interop_require_default(require("mongoose"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const connect = async function connect(payload) {
    if (this.url === false) {
        return;
    }
    if (!payload.local && typeof this.url !== 'string') {
        throw new Error('Error: missing MongoDB connection URL.');
    }
    let urlToConnect = this.url;
    let successfulConnectionMessage = 'Connected to MongoDB server successfully!';
    const connectionOptions = {
        autoIndex: true,
        ...this.connectOptions,
        useFacet: undefined
    };
    if (process.env.NODE_ENV === 'test') {
        if (process.env.PAYLOAD_TEST_MONGO_URL) {
            urlToConnect = process.env.PAYLOAD_TEST_MONGO_URL;
        } else {
            connectionOptions.dbName = 'payloadmemory';
            const { MongoMemoryServer } = require('mongodb-memory-server');
            const getPort = require('get-port');
            const port = await getPort();
            this.mongoMemoryServer = await MongoMemoryServer.create({
                instance: {
                    dbName: 'payloadmemory',
                    port
                }
            });
            urlToConnect = this.mongoMemoryServer.getUri();
            successfulConnectionMessage = 'Connected to in-memory MongoDB server successfully!';
        }
    }
    try {
        this.connection = (await _mongoose.default.connect(urlToConnect, connectionOptions)).connection;
        const client = this.connection.getClient();
        if (!client.options.replicaSet) {
            this.transactionOptions = false;
            this.beginTransaction = undefined;
        }
        if (process.env.PAYLOAD_DROP_DATABASE === 'true') {
            this.payload.logger.info('---- DROPPING DATABASE ----');
            await _mongoose.default.connection.dropDatabase();
            this.payload.logger.info('---- DROPPED DATABASE ----');
        }
        this.payload.logger.info(successfulConnectionMessage);
    } catch (err) {
        this.payload.logger.error(`Error: cannot connect to MongoDB. Details: ${err.message}`, err);
        process.exit(1);
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25uZWN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXMgKi9cbmltcG9ydCB0eXBlIHsgQ29ubmVjdE9wdGlvbnMgfSBmcm9tICdtb25nb29zZSdcbmltcG9ydCB0eXBlIHsgQ29ubmVjdCB9IGZyb20gJ3BheWxvYWQvZGF0YWJhc2UnXG5cbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSdcblxuaW1wb3J0IHR5cGUgeyBNb25nb29zZUFkYXB0ZXIgfSBmcm9tICcuJ1xuXG5leHBvcnQgY29uc3QgY29ubmVjdDogQ29ubmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGNvbm5lY3QodGhpczogTW9uZ29vc2VBZGFwdGVyLCBwYXlsb2FkKSB7XG4gIGlmICh0aGlzLnVybCA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGlmICghcGF5bG9hZC5sb2NhbCAmJiB0eXBlb2YgdGhpcy51cmwgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvcjogbWlzc2luZyBNb25nb0RCIGNvbm5lY3Rpb24gVVJMLicpXG4gIH1cblxuICBsZXQgdXJsVG9Db25uZWN0ID0gdGhpcy51cmxcbiAgbGV0IHN1Y2Nlc3NmdWxDb25uZWN0aW9uTWVzc2FnZSA9ICdDb25uZWN0ZWQgdG8gTW9uZ29EQiBzZXJ2ZXIgc3VjY2Vzc2Z1bGx5ISdcblxuICBjb25zdCBjb25uZWN0aW9uT3B0aW9uczogQ29ubmVjdE9wdGlvbnMgJiB7IHVzZUZhY2V0OiB1bmRlZmluZWQgfSA9IHtcbiAgICBhdXRvSW5kZXg6IHRydWUsXG4gICAgLi4udGhpcy5jb25uZWN0T3B0aW9ucyxcbiAgICB1c2VGYWNldDogdW5kZWZpbmVkLFxuICB9XG5cbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuUEFZTE9BRF9URVNUX01PTkdPX1VSTCkge1xuICAgICAgdXJsVG9Db25uZWN0ID0gcHJvY2Vzcy5lbnYuUEFZTE9BRF9URVNUX01PTkdPX1VSTFxuICAgIH0gZWxzZSB7XG4gICAgICBjb25uZWN0aW9uT3B0aW9ucy5kYk5hbWUgPSAncGF5bG9hZG1lbW9yeSdcbiAgICAgIGNvbnN0IHsgTW9uZ29NZW1vcnlTZXJ2ZXIgfSA9IHJlcXVpcmUoJ21vbmdvZGItbWVtb3J5LXNlcnZlcicpXG4gICAgICBjb25zdCBnZXRQb3J0ID0gcmVxdWlyZSgnZ2V0LXBvcnQnKVxuXG4gICAgICBjb25zdCBwb3J0ID0gYXdhaXQgZ2V0UG9ydCgpXG4gICAgICB0aGlzLm1vbmdvTWVtb3J5U2VydmVyID0gYXdhaXQgTW9uZ29NZW1vcnlTZXJ2ZXIuY3JlYXRlKHtcbiAgICAgICAgaW5zdGFuY2U6IHtcbiAgICAgICAgICBkYk5hbWU6ICdwYXlsb2FkbWVtb3J5JyxcbiAgICAgICAgICBwb3J0LFxuICAgICAgICB9LFxuICAgICAgfSlcblxuICAgICAgdXJsVG9Db25uZWN0ID0gdGhpcy5tb25nb01lbW9yeVNlcnZlci5nZXRVcmkoKVxuICAgICAgc3VjY2Vzc2Z1bENvbm5lY3Rpb25NZXNzYWdlID0gJ0Nvbm5lY3RlZCB0byBpbi1tZW1vcnkgTW9uZ29EQiBzZXJ2ZXIgc3VjY2Vzc2Z1bGx5ISdcbiAgICB9XG4gIH1cblxuICB0cnkge1xuICAgIHRoaXMuY29ubmVjdGlvbiA9IChhd2FpdCBtb25nb29zZS5jb25uZWN0KHVybFRvQ29ubmVjdCwgY29ubmVjdGlvbk9wdGlvbnMpKS5jb25uZWN0aW9uXG5cbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0Q2xpZW50KClcblxuICAgIGlmICghY2xpZW50Lm9wdGlvbnMucmVwbGljYVNldCkge1xuICAgICAgdGhpcy50cmFuc2FjdGlvbk9wdGlvbnMgPSBmYWxzZVxuICAgICAgdGhpcy5iZWdpblRyYW5zYWN0aW9uID0gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgaWYgKHByb2Nlc3MuZW52LlBBWUxPQURfRFJPUF9EQVRBQkFTRSA9PT0gJ3RydWUnKSB7XG4gICAgICB0aGlzLnBheWxvYWQubG9nZ2VyLmluZm8oJy0tLS0gRFJPUFBJTkcgREFUQUJBU0UgLS0tLScpXG4gICAgICBhd2FpdCBtb25nb29zZS5jb25uZWN0aW9uLmRyb3BEYXRhYmFzZSgpXG4gICAgICB0aGlzLnBheWxvYWQubG9nZ2VyLmluZm8oJy0tLS0gRFJPUFBFRCBEQVRBQkFTRSAtLS0tJylcbiAgICB9XG4gICAgdGhpcy5wYXlsb2FkLmxvZ2dlci5pbmZvKHN1Y2Nlc3NmdWxDb25uZWN0aW9uTWVzc2FnZSlcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhpcy5wYXlsb2FkLmxvZ2dlci5lcnJvcihgRXJyb3I6IGNhbm5vdCBjb25uZWN0IHRvIE1vbmdvREIuIERldGFpbHM6ICR7ZXJyLm1lc3NhZ2V9YCwgZXJyKVxuICAgIHByb2Nlc3MuZXhpdCgxKVxuICB9XG59XG4iXSwibmFtZXMiOlsiY29ubmVjdCIsInBheWxvYWQiLCJ1cmwiLCJsb2NhbCIsIkVycm9yIiwidXJsVG9Db25uZWN0Iiwic3VjY2Vzc2Z1bENvbm5lY3Rpb25NZXNzYWdlIiwiY29ubmVjdGlvbk9wdGlvbnMiLCJhdXRvSW5kZXgiLCJjb25uZWN0T3B0aW9ucyIsInVzZUZhY2V0IiwidW5kZWZpbmVkIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiUEFZTE9BRF9URVNUX01PTkdPX1VSTCIsImRiTmFtZSIsIk1vbmdvTWVtb3J5U2VydmVyIiwicmVxdWlyZSIsImdldFBvcnQiLCJwb3J0IiwibW9uZ29NZW1vcnlTZXJ2ZXIiLCJjcmVhdGUiLCJpbnN0YW5jZSIsImdldFVyaSIsImNvbm5lY3Rpb24iLCJtb25nb29zZSIsImNsaWVudCIsImdldENsaWVudCIsIm9wdGlvbnMiLCJyZXBsaWNhU2V0IiwidHJhbnNhY3Rpb25PcHRpb25zIiwiYmVnaW5UcmFuc2FjdGlvbiIsIlBBWUxPQURfRFJPUF9EQVRBQkFTRSIsImxvZ2dlciIsImluZm8iLCJkcm9wRGF0YWJhc2UiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJleGl0Il0sIm1hcHBpbmdzIjoiQUFBQSxxREFBcUQ7Ozs7K0JBUXhDQTs7O2VBQUFBOzs7aUVBSlE7Ozs7OztBQUlkLE1BQU1BLFVBQW1CLGVBQWVBLFFBQStCQyxPQUFPO0lBQ25GLElBQUksSUFBSSxDQUFDQyxHQUFHLEtBQUssT0FBTztRQUN0QjtJQUNGO0lBRUEsSUFBSSxDQUFDRCxRQUFRRSxLQUFLLElBQUksT0FBTyxJQUFJLENBQUNELEdBQUcsS0FBSyxVQUFVO1FBQ2xELE1BQU0sSUFBSUUsTUFBTTtJQUNsQjtJQUVBLElBQUlDLGVBQWUsSUFBSSxDQUFDSCxHQUFHO0lBQzNCLElBQUlJLDhCQUE4QjtJQUVsQyxNQUFNQyxvQkFBOEQ7UUFDbEVDLFdBQVc7UUFDWCxHQUFHLElBQUksQ0FBQ0MsY0FBYztRQUN0QkMsVUFBVUM7SUFDWjtJQUVBLElBQUlDLFFBQVFDLEdBQUcsQ0FBQ0MsUUFBUSxLQUFLLFFBQVE7UUFDbkMsSUFBSUYsUUFBUUMsR0FBRyxDQUFDRSxzQkFBc0IsRUFBRTtZQUN0Q1YsZUFBZU8sUUFBUUMsR0FBRyxDQUFDRSxzQkFBc0I7UUFDbkQsT0FBTztZQUNMUixrQkFBa0JTLE1BQU0sR0FBRztZQUMzQixNQUFNLEVBQUVDLGlCQUFpQixFQUFFLEdBQUdDLFFBQVE7WUFDdEMsTUFBTUMsVUFBVUQsUUFBUTtZQUV4QixNQUFNRSxPQUFPLE1BQU1EO1lBQ25CLElBQUksQ0FBQ0UsaUJBQWlCLEdBQUcsTUFBTUosa0JBQWtCSyxNQUFNLENBQUM7Z0JBQ3REQyxVQUFVO29CQUNSUCxRQUFRO29CQUNSSTtnQkFDRjtZQUNGO1lBRUFmLGVBQWUsSUFBSSxDQUFDZ0IsaUJBQWlCLENBQUNHLE1BQU07WUFDNUNsQiw4QkFBOEI7UUFDaEM7SUFDRjtJQUVBLElBQUk7UUFDRixJQUFJLENBQUNtQixVQUFVLEdBQUcsQUFBQyxDQUFBLE1BQU1DLGlCQUFRLENBQUMxQixPQUFPLENBQUNLLGNBQWNFLGtCQUFpQixFQUFHa0IsVUFBVTtRQUV0RixNQUFNRSxTQUFTLElBQUksQ0FBQ0YsVUFBVSxDQUFDRyxTQUFTO1FBRXhDLElBQUksQ0FBQ0QsT0FBT0UsT0FBTyxDQUFDQyxVQUFVLEVBQUU7WUFDOUIsSUFBSSxDQUFDQyxrQkFBa0IsR0FBRztZQUMxQixJQUFJLENBQUNDLGdCQUFnQixHQUFHckI7UUFDMUI7UUFFQSxJQUFJQyxRQUFRQyxHQUFHLENBQUNvQixxQkFBcUIsS0FBSyxRQUFRO1lBQ2hELElBQUksQ0FBQ2hDLE9BQU8sQ0FBQ2lDLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDO1lBQ3pCLE1BQU1ULGlCQUFRLENBQUNELFVBQVUsQ0FBQ1csWUFBWTtZQUN0QyxJQUFJLENBQUNuQyxPQUFPLENBQUNpQyxNQUFNLENBQUNDLElBQUksQ0FBQztRQUMzQjtRQUNBLElBQUksQ0FBQ2xDLE9BQU8sQ0FBQ2lDLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDN0I7SUFDM0IsRUFBRSxPQUFPK0IsS0FBSztRQUNaLElBQUksQ0FBQ3BDLE9BQU8sQ0FBQ2lDLE1BQU0sQ0FBQ0ksS0FBSyxDQUFDLENBQUMsMkNBQTJDLEVBQUVELElBQUlFLE9BQU8sQ0FBQyxDQUFDLEVBQUVGO1FBQ3ZGekIsUUFBUTRCLElBQUksQ0FBQztJQUNmO0FBQ0YifQ==