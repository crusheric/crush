"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _serializeLexical = require("../../../utilities/lexical/serializeLexical");
const _replaceDoubleCurlys = require("../../../utilities/replaceDoubleCurlys");
const _serializeSlate = require("../../../utilities/slate/serializeSlate");
const sendEmail = async (beforeChangeData, formConfig)=>{
    const { data, operation } = beforeChangeData;
    if (operation === 'create') {
        const { data: { id: formSubmissionID }, req: { locale, payload } } = beforeChangeData;
        const { form: formID, submissionData } = data || {};
        const { beforeEmail, formOverrides } = formConfig || {};
        try {
            const form = await payload.findByID({
                id: formID,
                collection: formOverrides?.slug || 'forms',
                locale
            });
            const { emails } = form;
            if (emails && emails.length) {
                const formattedEmails = await Promise.all(emails.map(async (email)=>{
                    const { bcc: emailBCC, cc: emailCC, emailFrom, emailTo, message, replyTo: emailReplyTo, subject } = email;
                    const to = (0, _replaceDoubleCurlys.replaceDoubleCurlys)(emailTo, submissionData);
                    const cc = emailCC ? (0, _replaceDoubleCurlys.replaceDoubleCurlys)(emailCC, submissionData) : '';
                    const bcc = emailBCC ? (0, _replaceDoubleCurlys.replaceDoubleCurlys)(emailBCC, submissionData) : '';
                    const from = (0, _replaceDoubleCurlys.replaceDoubleCurlys)(emailFrom, submissionData);
                    const replyTo = (0, _replaceDoubleCurlys.replaceDoubleCurlys)(emailReplyTo || emailFrom, submissionData);
                    const isLexical = message && !Array.isArray(message) && 'root' in message;
                    const serializedMessage = isLexical ? await (0, _serializeLexical.serializeLexical)(message, submissionData) : (0, _serializeSlate.serializeSlate)(message, submissionData);
                    return {
                        bcc,
                        cc,
                        from,
                        html: `<div>${serializedMessage}</div>`,
                        replyTo,
                        subject: (0, _replaceDoubleCurlys.replaceDoubleCurlys)(subject, submissionData),
                        to
                    };
                }));
                let emailsToSend = formattedEmails;
                if (typeof beforeEmail === 'function') {
                    emailsToSend = await beforeEmail(formattedEmails);
                }
                // const log = emailsToSend.map(({ html, ...rest }) => ({ ...rest }))
                await Promise.all(emailsToSend.map(async (email)=>{
                    const { to } = email;
                    try {
                        const emailPromise = await payload.sendEmail(email);
                        return emailPromise;
                    } catch (err) {
                        payload.logger.error({
                            err: `Error while sending email to address: ${to}. Email not sent: ${JSON.stringify(err)}`
                        });
                    }
                }));
            } else {
                payload.logger.info({
                    msg: 'No emails to send.'
                });
            }
        } catch (err) {
            const msg = `Error while sending one or more emails in form submission id: ${formSubmissionID}.`;
            payload.logger.error({
                err: msg
            });
        }
    }
    return data;
};
const _default = sendEmail;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb2xsZWN0aW9ucy9Gb3JtU3VibWlzc2lvbnMvaG9va3Mvc2VuZEVtYWlsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgRW1haWwsIEZvcm1hdHRlZEVtYWlsLCBQbHVnaW5Db25maWcgfSBmcm9tICcuLi8uLi8uLi90eXBlcydcblxuaW1wb3J0IHsgc2VyaWFsaXplTGV4aWNhbCB9IGZyb20gJy4uLy4uLy4uL3V0aWxpdGllcy9sZXhpY2FsL3NlcmlhbGl6ZUxleGljYWwnXG5pbXBvcnQgeyByZXBsYWNlRG91YmxlQ3VybHlzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0aWVzL3JlcGxhY2VEb3VibGVDdXJseXMnXG5pbXBvcnQgeyBzZXJpYWxpemVTbGF0ZSB9IGZyb20gJy4uLy4uLy4uL3V0aWxpdGllcy9zbGF0ZS9zZXJpYWxpemVTbGF0ZSdcblxuY29uc3Qgc2VuZEVtYWlsID0gYXN5bmMgKGJlZm9yZUNoYW5nZURhdGE6IGFueSwgZm9ybUNvbmZpZzogUGx1Z2luQ29uZmlnKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgY29uc3QgeyBkYXRhLCBvcGVyYXRpb24gfSA9IGJlZm9yZUNoYW5nZURhdGFcblxuICBpZiAob3BlcmF0aW9uID09PSAnY3JlYXRlJykge1xuICAgIGNvbnN0IHtcbiAgICAgIGRhdGE6IHsgaWQ6IGZvcm1TdWJtaXNzaW9uSUQgfSxcbiAgICAgIHJlcTogeyBsb2NhbGUsIHBheWxvYWQgfSxcbiAgICB9ID0gYmVmb3JlQ2hhbmdlRGF0YVxuXG4gICAgY29uc3QgeyBmb3JtOiBmb3JtSUQsIHN1Ym1pc3Npb25EYXRhIH0gPSBkYXRhIHx8IHt9XG5cbiAgICBjb25zdCB7IGJlZm9yZUVtYWlsLCBmb3JtT3ZlcnJpZGVzIH0gPSBmb3JtQ29uZmlnIHx8IHt9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgZm9ybSA9IGF3YWl0IHBheWxvYWQuZmluZEJ5SUQoe1xuICAgICAgICBpZDogZm9ybUlELFxuICAgICAgICBjb2xsZWN0aW9uOiBmb3JtT3ZlcnJpZGVzPy5zbHVnIHx8ICdmb3JtcycsXG4gICAgICAgIGxvY2FsZSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IHsgZW1haWxzIH0gPSBmb3JtXG5cbiAgICAgIGlmIChlbWFpbHMgJiYgZW1haWxzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWRFbWFpbHM6IEZvcm1hdHRlZEVtYWlsW10gPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICBlbWFpbHMubWFwKGFzeW5jIChlbWFpbDogRW1haWwpOiBQcm9taXNlPEZvcm1hdHRlZEVtYWlsIHwgbnVsbD4gPT4ge1xuICAgICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgICBiY2M6IGVtYWlsQkNDLFxuICAgICAgICAgICAgICBjYzogZW1haWxDQyxcbiAgICAgICAgICAgICAgZW1haWxGcm9tLFxuICAgICAgICAgICAgICBlbWFpbFRvLFxuICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICByZXBseVRvOiBlbWFpbFJlcGx5VG8sXG4gICAgICAgICAgICAgIHN1YmplY3QsXG4gICAgICAgICAgICB9ID0gZW1haWxcblxuICAgICAgICAgICAgY29uc3QgdG8gPSByZXBsYWNlRG91YmxlQ3VybHlzKGVtYWlsVG8sIHN1Ym1pc3Npb25EYXRhKVxuICAgICAgICAgICAgY29uc3QgY2MgPSBlbWFpbENDID8gcmVwbGFjZURvdWJsZUN1cmx5cyhlbWFpbENDLCBzdWJtaXNzaW9uRGF0YSkgOiAnJ1xuICAgICAgICAgICAgY29uc3QgYmNjID0gZW1haWxCQ0MgPyByZXBsYWNlRG91YmxlQ3VybHlzKGVtYWlsQkNDLCBzdWJtaXNzaW9uRGF0YSkgOiAnJ1xuICAgICAgICAgICAgY29uc3QgZnJvbSA9IHJlcGxhY2VEb3VibGVDdXJseXMoZW1haWxGcm9tLCBzdWJtaXNzaW9uRGF0YSlcbiAgICAgICAgICAgIGNvbnN0IHJlcGx5VG8gPSByZXBsYWNlRG91YmxlQ3VybHlzKGVtYWlsUmVwbHlUbyB8fCBlbWFpbEZyb20sIHN1Ym1pc3Npb25EYXRhKVxuXG4gICAgICAgICAgICBjb25zdCBpc0xleGljYWwgPSBtZXNzYWdlICYmICFBcnJheS5pc0FycmF5KG1lc3NhZ2UpICYmICdyb290JyBpbiBtZXNzYWdlXG5cbiAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6ZWRNZXNzYWdlID0gaXNMZXhpY2FsXG4gICAgICAgICAgICAgID8gYXdhaXQgc2VyaWFsaXplTGV4aWNhbChtZXNzYWdlLCBzdWJtaXNzaW9uRGF0YSlcbiAgICAgICAgICAgICAgOiBzZXJpYWxpemVTbGF0ZShtZXNzYWdlLCBzdWJtaXNzaW9uRGF0YSlcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgYmNjLFxuICAgICAgICAgICAgICBjYyxcbiAgICAgICAgICAgICAgZnJvbSxcbiAgICAgICAgICAgICAgaHRtbDogYDxkaXY+JHtzZXJpYWxpemVkTWVzc2FnZX08L2Rpdj5gLFxuICAgICAgICAgICAgICByZXBseVRvLFxuICAgICAgICAgICAgICBzdWJqZWN0OiByZXBsYWNlRG91YmxlQ3VybHlzKHN1YmplY3QsIHN1Ym1pc3Npb25EYXRhKSxcbiAgICAgICAgICAgICAgdG8sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSksXG4gICAgICAgIClcblxuICAgICAgICBsZXQgZW1haWxzVG9TZW5kID0gZm9ybWF0dGVkRW1haWxzXG5cbiAgICAgICAgaWYgKHR5cGVvZiBiZWZvcmVFbWFpbCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGVtYWlsc1RvU2VuZCA9IGF3YWl0IGJlZm9yZUVtYWlsKGZvcm1hdHRlZEVtYWlscylcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNvbnN0IGxvZyA9IGVtYWlsc1RvU2VuZC5tYXAoKHsgaHRtbCwgLi4ucmVzdCB9KSA9PiAoeyAuLi5yZXN0IH0pKVxuXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgIGVtYWlsc1RvU2VuZC5tYXAoYXN5bmMgKGVtYWlsKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHRvIH0gPSBlbWFpbFxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3QgZW1haWxQcm9taXNlID0gYXdhaXQgcGF5bG9hZC5zZW5kRW1haWwoZW1haWwpXG4gICAgICAgICAgICAgIHJldHVybiBlbWFpbFByb21pc2VcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgICAgICAgICBwYXlsb2FkLmxvZ2dlci5lcnJvcih7XG4gICAgICAgICAgICAgICAgZXJyOiBgRXJyb3Igd2hpbGUgc2VuZGluZyBlbWFpbCB0byBhZGRyZXNzOiAke3RvfS4gRW1haWwgbm90IHNlbnQ6ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICAgICAgICBlcnIsXG4gICAgICAgICAgICAgICAgKX1gLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXlsb2FkLmxvZ2dlci5pbmZvKHsgbXNnOiAnTm8gZW1haWxzIHRvIHNlbmQuJyB9KVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgY29uc3QgbXNnID0gYEVycm9yIHdoaWxlIHNlbmRpbmcgb25lIG9yIG1vcmUgZW1haWxzIGluIGZvcm0gc3VibWlzc2lvbiBpZDogJHtmb3JtU3VibWlzc2lvbklEfS5gXG4gICAgICBwYXlsb2FkLmxvZ2dlci5lcnJvcih7IGVycjogbXNnIH0pXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRhdGFcbn1cblxuZXhwb3J0IGRlZmF1bHQgc2VuZEVtYWlsXG4iXSwibmFtZXMiOlsic2VuZEVtYWlsIiwiYmVmb3JlQ2hhbmdlRGF0YSIsImZvcm1Db25maWciLCJkYXRhIiwib3BlcmF0aW9uIiwiaWQiLCJmb3JtU3VibWlzc2lvbklEIiwicmVxIiwibG9jYWxlIiwicGF5bG9hZCIsImZvcm0iLCJmb3JtSUQiLCJzdWJtaXNzaW9uRGF0YSIsImJlZm9yZUVtYWlsIiwiZm9ybU92ZXJyaWRlcyIsImZpbmRCeUlEIiwiY29sbGVjdGlvbiIsInNsdWciLCJlbWFpbHMiLCJsZW5ndGgiLCJmb3JtYXR0ZWRFbWFpbHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiZW1haWwiLCJiY2MiLCJlbWFpbEJDQyIsImNjIiwiZW1haWxDQyIsImVtYWlsRnJvbSIsImVtYWlsVG8iLCJtZXNzYWdlIiwicmVwbHlUbyIsImVtYWlsUmVwbHlUbyIsInN1YmplY3QiLCJ0byIsInJlcGxhY2VEb3VibGVDdXJseXMiLCJmcm9tIiwiaXNMZXhpY2FsIiwiQXJyYXkiLCJpc0FycmF5Iiwic2VyaWFsaXplZE1lc3NhZ2UiLCJzZXJpYWxpemVMZXhpY2FsIiwic2VyaWFsaXplU2xhdGUiLCJodG1sIiwiZW1haWxzVG9TZW5kIiwiZW1haWxQcm9taXNlIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwiaW5mbyIsIm1zZyJdLCJtYXBwaW5ncyI6Ijs7OzsrQkFvR0E7OztlQUFBOzs7a0NBbEdpQztxQ0FDRztnQ0FDTDtBQUUvQixNQUFNQSxZQUFZLE9BQU9DLGtCQUF1QkM7SUFDOUMsTUFBTSxFQUFFQyxJQUFJLEVBQUVDLFNBQVMsRUFBRSxHQUFHSDtJQUU1QixJQUFJRyxjQUFjLFVBQVU7UUFDMUIsTUFBTSxFQUNKRCxNQUFNLEVBQUVFLElBQUlDLGdCQUFnQixFQUFFLEVBQzlCQyxLQUFLLEVBQUVDLE1BQU0sRUFBRUMsT0FBTyxFQUFFLEVBQ3pCLEdBQUdSO1FBRUosTUFBTSxFQUFFUyxNQUFNQyxNQUFNLEVBQUVDLGNBQWMsRUFBRSxHQUFHVCxRQUFRLENBQUM7UUFFbEQsTUFBTSxFQUFFVSxXQUFXLEVBQUVDLGFBQWEsRUFBRSxHQUFHWixjQUFjLENBQUM7UUFFdEQsSUFBSTtZQUNGLE1BQU1RLE9BQU8sTUFBTUQsUUFBUU0sUUFBUSxDQUFDO2dCQUNsQ1YsSUFBSU07Z0JBQ0pLLFlBQVlGLGVBQWVHLFFBQVE7Z0JBQ25DVDtZQUNGO1lBRUEsTUFBTSxFQUFFVSxNQUFNLEVBQUUsR0FBR1I7WUFFbkIsSUFBSVEsVUFBVUEsT0FBT0MsTUFBTSxFQUFFO2dCQUMzQixNQUFNQyxrQkFBb0MsTUFBTUMsUUFBUUMsR0FBRyxDQUN6REosT0FBT0ssR0FBRyxDQUFDLE9BQU9DO29CQUNoQixNQUFNLEVBQ0pDLEtBQUtDLFFBQVEsRUFDYkMsSUFBSUMsT0FBTyxFQUNYQyxTQUFTLEVBQ1RDLE9BQU8sRUFDUEMsT0FBTyxFQUNQQyxTQUFTQyxZQUFZLEVBQ3JCQyxPQUFPLEVBQ1IsR0FBR1Y7b0JBRUosTUFBTVcsS0FBS0MsSUFBQUEsd0NBQW1CLEVBQUNOLFNBQVNsQjtvQkFDeEMsTUFBTWUsS0FBS0MsVUFBVVEsSUFBQUEsd0NBQW1CLEVBQUNSLFNBQVNoQixrQkFBa0I7b0JBQ3BFLE1BQU1hLE1BQU1DLFdBQVdVLElBQUFBLHdDQUFtQixFQUFDVixVQUFVZCxrQkFBa0I7b0JBQ3ZFLE1BQU15QixPQUFPRCxJQUFBQSx3Q0FBbUIsRUFBQ1AsV0FBV2pCO29CQUM1QyxNQUFNb0IsVUFBVUksSUFBQUEsd0NBQW1CLEVBQUNILGdCQUFnQkosV0FBV2pCO29CQUUvRCxNQUFNMEIsWUFBWVAsV0FBVyxDQUFDUSxNQUFNQyxPQUFPLENBQUNULFlBQVksVUFBVUE7b0JBRWxFLE1BQU1VLG9CQUFvQkgsWUFDdEIsTUFBTUksSUFBQUEsa0NBQWdCLEVBQUNYLFNBQVNuQixrQkFDaEMrQixJQUFBQSw4QkFBYyxFQUFDWixTQUFTbkI7b0JBRTVCLE9BQU87d0JBQ0xhO3dCQUNBRTt3QkFDQVU7d0JBQ0FPLE1BQU0sQ0FBQyxLQUFLLEVBQUVILGtCQUFrQixNQUFNLENBQUM7d0JBQ3ZDVDt3QkFDQUUsU0FBU0UsSUFBQUEsd0NBQW1CLEVBQUNGLFNBQVN0Qjt3QkFDdEN1QjtvQkFDRjtnQkFDRjtnQkFHRixJQUFJVSxlQUFlekI7Z0JBRW5CLElBQUksT0FBT1AsZ0JBQWdCLFlBQVk7b0JBQ3JDZ0MsZUFBZSxNQUFNaEMsWUFBWU87Z0JBQ25DO2dCQUVBLHFFQUFxRTtnQkFFckUsTUFBTUMsUUFBUUMsR0FBRyxDQUNmdUIsYUFBYXRCLEdBQUcsQ0FBQyxPQUFPQztvQkFDdEIsTUFBTSxFQUFFVyxFQUFFLEVBQUUsR0FBR1g7b0JBQ2YsSUFBSTt3QkFDRixNQUFNc0IsZUFBZSxNQUFNckMsUUFBUVQsU0FBUyxDQUFDd0I7d0JBQzdDLE9BQU9zQjtvQkFDVCxFQUFFLE9BQU9DLEtBQWM7d0JBQ3JCdEMsUUFBUXVDLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDOzRCQUNuQkYsS0FBSyxDQUFDLHNDQUFzQyxFQUFFWixHQUFHLGtCQUFrQixFQUFFZSxLQUFLQyxTQUFTLENBQ2pGSixLQUNBLENBQUM7d0JBQ0w7b0JBQ0Y7Z0JBQ0Y7WUFFSixPQUFPO2dCQUNMdEMsUUFBUXVDLE1BQU0sQ0FBQ0ksSUFBSSxDQUFDO29CQUFFQyxLQUFLO2dCQUFxQjtZQUNsRDtRQUNGLEVBQUUsT0FBT04sS0FBYztZQUNyQixNQUFNTSxNQUFNLENBQUMsOERBQThELEVBQUUvQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ2hHRyxRQUFRdUMsTUFBTSxDQUFDQyxLQUFLLENBQUM7Z0JBQUVGLEtBQUtNO1lBQUk7UUFDbEM7SUFDRjtJQUVBLE9BQU9sRDtBQUNUO01BRUEsV0FBZUgifQ==